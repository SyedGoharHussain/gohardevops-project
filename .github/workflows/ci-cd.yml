name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/gohardevops-project
  AWS_REGION: us-east-1

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-flask
    
    - name: Run tests
      run: |
        # Create a simple test file if it doesn't exist
        if [ ! -f "test_app.py" ]; then
          echo "from app import create_app
import pytest

@pytest.fixture
def client():
    app = create_app()
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client

def test_index(client):
    response = client.get('/')
    assert response.status_code == 200

def test_api(client):
    response = client.get('/api/hello')
    assert response.status_code == 200
    assert b'message' in response.data" > test_app.py
        fi
        python -m pytest test_app.py -v
    
    - name: Security scan with Bandit
      run: |
        pip install bandit
        bandit -r app/ -f json -o bandit-results.json || true

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        # Create SSH key file
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        echo "Stopping existing containers..."
        docker-compose down || true
        
        echo "Removing old images..."
        docker system prune -f
        
        echo "Logging into Docker Hub..."
        echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
        
        echo "Pulling latest image..."
        docker pull $DOCKERHUB_USERNAME/gohardevops-project:latest
        
        echo "Creating docker-compose.yml..."
        cat > docker-compose.yml << 'INNER_EOF'
        version: '3.8'
        services:
          web:
            image: $DOCKERHUB_USERNAME/gohardevops-project:latest
            ports:
              - "80:5000"
              - "5000:5000"
            restart: always
            environment:
              - FLASK_ENV=production
        INNER_EOF
        
        echo "Starting application..."
        docker-compose up -d
        
        echo "Cleaning up..."
        docker image prune -f
        EOF
        
        # Copy and execute deployment script
        scp -i private_key.pem -o StrictHostKeyChecking=no deploy.sh $EC2_USER@$EC2_HOST:/tmp/
        ssh -i private_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"
        
        # Cleanup
        rm -f private_key.pem deploy.sh

  infrastructure:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'
    
    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init
    
    - name: Terraform Plan
      working-directory: ./terraform
      run: terraform plan -var="key_pair_name=${{ secrets.AWS_KEY_PAIR_NAME }}" -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}"
    
    - name: Terraform Apply
      working-directory: ./terraform
      if: github.ref == 'refs/heads/main'
      run: terraform apply -auto-approve -var="key_pair_name=${{ secrets.AWS_KEY_PAIR_NAME }}" -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}"