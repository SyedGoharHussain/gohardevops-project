name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/gohardevops-project:latest .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/gohardevops-project:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        # Create SSH key file
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        echo "=== Deploying Flask App ==="
        
        # Stop and remove old container
        docker stop flask-app 2>/dev/null || true
        docker rm flask-app 2>/dev/null || true
        
        # Login to Docker Hub
        echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
        
        # Pull latest image
        docker pull $DOCKERHUB_USERNAME/gohardevops-project:latest
        
        # Run new container
        docker run -d \
          --name flask-app \
          -p 80:5000 \
          -p 5000:5000 \
          --restart always \
          $DOCKERHUB_USERNAME/gohardevops-project:latest
        
        echo "=== Deployment Complete ==="
        docker ps
        EOF
        
        # Make script executable and copy to EC2
        chmod +x deploy.sh
        scp -i private_key.pem -o StrictHostKeyChecking=no deploy.sh $EC2_USER@$EC2_HOST:/tmp/
        
        # Run deployment script on EC2
        ssh -i private_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "bash /tmp/deploy.sh"
        
        # Cleanup
        rm -f private_key.pem deploy.sh