name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t syedgoharhussain/gohardevops-project:latest .
    
    - name: Push to Docker Hub
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
        docker push syedgoharhussain/gohardevops-project:latest
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        # Create SSH key file
        echo "$SSH_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        echo "=== Automated Deployment ==="
        
        # Pull latest image
        docker pull syedgoharhussain/gohardevops-project:latest
        
        # Stop and remove old container
        docker stop flask-app 2>/dev/null || true
        docker rm flask-app 2>/dev/null || true
        
        # Run new container
        docker run -d \
          --name flask-app \
          -p 80:5000 \
          -p 5000:5000 \
          --restart always \
          syedgoharhussain/gohardevops-project:latest
        
        echo "=== Deployment Complete ==="
        docker ps
        EOF
        
        # Copy and execute on EC2
        scp -i private_key.pem -o StrictHostKeyChecking=no deploy.sh $EC2_USER@$EC2_HOST:/tmp/
        ssh -i private_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"
        
        # Cleanup
        rm -f private_key.pem deploy.sh